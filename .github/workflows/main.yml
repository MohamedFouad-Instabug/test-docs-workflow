name: Test PR Creation to Docs Repository

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  test-docs-pr:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create test PR to docs repository
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DOCS_PAT }}
          script: |
            try {
              // Create a new branch name
              const branchName = 'test-pr-' + Date.now();
              const docsOwner = 'MohamedFouad-Instabug';
              const docsRepo = 'Docs';
              const baseBranch = 'main';
              
              console.log('Starting PR creation process...');
              console.log('Target repository:', docsOwner + '/' + docsRepo);
              
              // Get the base branch ref
              console.log('Getting base branch ref...');
              const baseRef = await github.rest.git.getRef({
                owner: docsOwner,
                repo: docsRepo,
                ref: 'heads/' + baseBranch
              });
              
              console.log('Base ref obtained:', baseRef.data.object.sha);
              
              // Create a new branch
              console.log('Creating new branch:', branchName);
              await github.rest.git.createRef({
                owner: docsOwner,
                repo: docsRepo,
                ref: 'refs/heads/' + branchName,
                sha: baseRef.data.object.sha
              });
              
              console.log('Branch created successfully');
              
              // Create a test file
              console.log('Creating test file...');
              await github.rest.repos.createOrUpdateFileContents({
                owner: docsOwner,
                repo: docsRepo,
                path: 'test-file.md',
                message: 'Test PR creation from workflow',
                content: Buffer.from('# Test File\n\nThis is a test file created by the workflow.').toString('base64'),
                branch: branchName
              });
              
              console.log('Test file created successfully');
              
              // Create pull request in docs repo
              console.log('Creating pull request...');
              const docsPR = await github.rest.pulls.create({
                owner: docsOwner,
                repo: docsRepo,
                title: 'Test PR from workflow',
                head: branchName,
                base: baseBranch,
                body: 'This is a test PR created by the GitHub Actions workflow to verify PR creation functionality.'
              });
              
              console.log('PR created successfully:', docsPR.data.number);
              
              // Comment on original PR about the docs PR
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'Test PR created successfully: [' + docsOwner + '/' + docsRepo + '#' + docsPR.data.number + '](' + docsPR.data.html_url + ')'
              });
              
            } catch (error) {
              console.error('Error creating test PR:', error);
              console.error('Error details:', error.response?.data);
              
              // Comment on original PR about the error
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'Error creating test PR: ' + error.message + '\n\nDetails: ' + JSON.stringify(error.response?.data || {})
              });
            } 
