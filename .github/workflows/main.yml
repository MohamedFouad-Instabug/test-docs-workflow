name: Test PR Creation to Docs Repository

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  test-docs-pr:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create test PR to docs repository
        uses: actions/github-script@v7
        env:
          DOCS_PAT: ${{ secrets.DOCS_PAT }}
        with:
          script: |
            try {
              // Create a new branch name
              const branchName = 'test-pr-' + Date.now();
              const docsOwner = 'MohamedFouad-Instabug';
              const docsRepo = 'Docs';
              const baseBranch = 'main';
              
              // Get the base branch ref
              const baseRef = await github.rest.git.getRef({
                owner: docsOwner,
                repo: docsRepo,
                ref: 'heads/' + baseBranch,
                headers: {
                  authorization: 'token ' + process.env.DOCS_PAT
                }
              });
              
              // Create a new branch
              await github.rest.git.createRef({
                owner: docsOwner,
                repo: docsRepo,
                ref: 'refs/heads/' + branchName,
                sha: baseRef.data.object.sha,
                headers: {
                  authorization: 'token ' + process.env.DOCS_PAT
                }
              });
              
              // Create a test file
              await github.rest.repos.createOrUpdateFileContents({
                owner: docsOwner,
                repo: docsRepo,
                path: 'test-file.md',
                message: 'Test PR creation from workflow',
                content: Buffer.from('# Test File\n\nThis is a test file created by the workflow.').toString('base64'),
                branch: branchName,
                headers: {
                  authorization: 'token ' + process.env.DOCS_PAT
                }
              });
              
              // Create pull request in docs repo
              const docsPR = await github.rest.pulls.create({
                owner: docsOwner,
                repo: docsRepo,
                title: 'Test PR from workflow',
                head: branchName,
                base: baseBranch,
                body: 'This is a test PR created by the GitHub Actions workflow to verify PR creation functionality.',
                headers: {
                  authorization: 'token ' + process.env.DOCS_PAT
                }
              });
              
              // Comment on original PR about the docs PR
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'Test PR created successfully: [' + docsOwner + '/' + docsRepo + '#' + docsPR.data.number + '](' + docsPR.data.html_url + ')'
              });
              
            } catch (error) {
              console.error('Error creating test PR:', error);
              
              // Comment on original PR about the error
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'Error creating test PR: ' + error.message
              });
            } 
